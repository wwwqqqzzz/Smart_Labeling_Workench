# 实施计划

## 📅 总体时间表

| 阶段 | 时间 | 交付物 | 负责人 |
|------|------|--------|--------|
| **第 1 周** | 基础框架搭建 | 前后端项目框架、数据库设计 | 后端 + 前端 |
| **第 2 周** | 核心功能开发 | 对话展示、标签操作 | 前端 + 后端 |
| **第 3 周** | RAG 引擎开发 | 向量库、LLM 判断 | AI 工程师 |
| **第 4 周** | 前后端集成 | 完整可用的 MVP | 全员 |
| **第 5 周** | 优化完善 | 性能优化、体验提升 | 全员 |
| **第 6 周** | 测试上线 | 测试报告、用户文档 | 全员 |

---

## 🎯 第 1 周：基础框架搭建（1月13日 - 1月19日）

### 目标
搭建前后端项目框架，完成数据库设计，实现 Excel 数据导入。

### 任务清单

#### 后端（3天）

**Day 1-2：项目初始化**
- [ ] 创建 FastAPI 项目
  ```bash
  mkdir backend && cd backend
  python -m venv venv
  source venv/bin/activate
  pip install fastapi uvicorn sqlalchemy pandas
  ```
- [ ] 配置项目结构
  ```
  backend/
  ├── app/
  │   ├── __init__.py
  │   ├── main.py              # FastAPI 应用入口
  │   ├── models/              # SQLAlchemy 模型
  │   │   ├── __init__.py
  │   │   ├── conversation.py
  │   │   ├── tag.py
  │   │   └── audit_log.py
  │   ├── schemas/             # Pydantic 模式
  │   │   ├── __init__.py
  │   │   ├── conversation.py
  │   │   └── tag.py
  │   ├── services/            # 业务逻辑
  │   │   ├── __init__.py
  │   │   ├── conversation_service.py
  │   │   └── data_importer.py
  │   ├── database.py          # 数据库连接
  │   └── config.py            # 配置
  ├── requirements.txt
  └── .env                     # 环境变量
  ```
- [ ] 编写配置文件
  ```python
  # config.py
  from pydantic_settings import BaseSettings

  class Settings(BaseSettings):
    DATABASE_URL: str = "sqlite:///./data/conversations.db"
    GLM_API_KEY: str
    OPENAI_API_KEY: str
    REDIS_URL: str = "redis://localhost:6379"

    class Config:
      env_file = ".env"
  ```

**Day 3：数据库实现**
- [ ] 定义 SQLAlchemy 模型
  - conversations 表
  - tags 表
  - audit_logs 表
- [ ] 创建数据库初始化脚本
  ```bash
  python -m app.database init
  ```
- [ ] 编写数据迁移脚本

#### 前端（2天）

**Day 4：Next.js 项目初始化**
- [ ] 创建 Next.js 项目
  ```bash
  npx create-next-app@latest frontend \
    --typescript \
    --tailwind \
    --app \
    --no-src-dir
  ```
- [ ] 安装依赖
  ```bash
  npm install zustand @tanstack/react-query
  npm install lucide-react clsx tailwind-merge
  ```
- [ ] 配置 shadcn/ui
  ```bash
  npx shadcn-ui@latest init
  npx shadcn-ui@latest add button card input
  ```

**Day 5：基础组件**
- [ ] 创建 Layout（左右分栏）
- [ ] 创建 Header（进度显示）
- [ ] 创建 Loading 组件
- [ ] 配置 Tailwind 主题

#### 验收标准
- ✅ 后端 API 能正常启动（`uvicorn app.main:app --reload`）
- ✅ 前端页面能正常访问（`npm run dev`）
- ✅ 数据库表结构创建成功
- ✅ 能导入 Excel 数据到数据库

---

## 🔨 第 2 周：核心功能开发（1月20日 - 1月26日）

### 目标
实现对话展示、标签操作等核心审核功能，完成基本的 CRUD。

### 任务清单

#### 后端（2天）

**Day 6-7：API 开发**
- [ ] 实现对话相关 API
  - `GET /api/v1/conversations` - 获取对话列表
  - `GET /api/v1/conversations/:id` - 获取单条对话
  - `PUT /api/v1/conversations/:id` - 更新对话标签
  - `GET /api/v1/stats` - 获取统计信息

- [ ] 实现标签相关 API
  - `GET /api/v1/tags` - 获取所有标签
  - `GET /api/v1/tags/:id` - 获取标签定义

- [ ] 编写 API 文档（自动生成 Swagger）
  访问：`http://localhost:8000/docs`

#### 前端（3天）

**Day 8：对话气泡组件**
- [ ] 实现 `ConversationBubble` 组件
  ```typescript
  // components/conversation-bubble.tsx
  interface ConversationBubbleProps {
    text: string
    role: 'driver' | 'owner'
  }

  export function ConversationBubble({
    text,
    role
  }: ConversationBubbleProps) {
    // 司机：绿色，右对齐
    // 货主：白色，左对齐
  }
  ```

- [ ] 实现对话解析逻辑
  ```typescript
  // lib/parser.ts
  export function parseConversation(text: string) {
    const segments = text.split('$_$')
    return segments.map(seg => {
      const [role, ...content] = seg.split('：')
      return {
        role: role.includes('司机') ? 'driver' : 'owner',
        content: content.join('：')
      }
    })
  }
  ```

**Day 9：关键词高亮**
- [ ] 定义关键词模式
  ```typescript
  // lib/constants.ts
  export const KEYWORD_PATTERNS = {
    '尾板': { tags: ['尾板车', '无尾板'], color: 'bg-red-200' },
    '高速费': { tags: ['过路/桥/船/高速费'], color: 'bg-red-200' },
    '装卸': { tags: ['装卸费', '搬运装卸'], color: 'bg-red-200' }
  }
  ```

- [ ] 实现高亮函数
  ```typescript
  // lib/highlight.ts
  export function highlightKeywords(
    text: string,
    patterns: KeywordPatterns
  ): string {
    let result = text
    for (const [keyword, config] of Object.entries(patterns)) {
      const regex = new RegExp(keyword, 'g')
      result = result.replace(
        regex,
        `<mark class="${config.color}">${keyword}</mark>`
      )
    }
    return result
  }
  ```

**Day 10：标签选择器**
- [ ] 实现 `TagSelector` 组件
  - 按分类展示 56 个标签
  - 点击标签自动填入
  - 支持多选

- [ ] 实现操作按钮
  - 确认按钮（使用 AI 标签）
  - 跳过按钮（存疑）
  - 修改按钮（自定义标签）

#### 验收标准
- ✅ 对话能正确显示为气泡
- ✅ 关键词能正确高亮
- ✅ 能选择标签并提交
- ✅ 能确认/跳过对话
- ✅ 数据能正确保存到数据库

---

## 🤖 第 3 周：RAG 引擎开发（1月27日 - 2月2日）

### 目标
构建向量库，实现 RAG 推荐引擎，集成 GLM-4。

### 任务清单

#### Day 11-12：向量库构建（2天）

- [ ] 安装依赖
  ```bash
  pip install chromadb langchain openai rank-bm25 jieba
  ```

- [ ] 实现向量库构建器
  ```python
  # services/vector_store_builder.py
  class VectorStoreBuilder:
      def build_from_tags(self, tags: List[Tag]) -> Chroma:
          # 为每个标签定义生成嵌入向量
          # 存入 Chroma
  ```

- [ ] 构建标签定义向量库
  ```python
  # scripts/build_vector_store.py
  tags = session.query(Tag).all()
  builder = VectorStoreBuilder()
  vector_store = builder.build_from_tags(tags)
  ```

#### Day 13-14：检索器实现（2天）

- [ ] 实现混合检索器
  ```python
  # rag/retriever.py
  class HybridRetriever:
      # 向量检索 + BM25
      async def retrieve(query, top_k=5):
          # 1. 向量检索
          # 2. BM25 检索
          # 3. 混合排序
  ```

- [ ] 测试检索准确率
  - 准备测试查询（如："有尾板"、"高速费"）
  - 验证 Top 5 结果是否相关

#### Day 15：LLM 集成（1天）

- [ ] 实现 GLM-4 客户端
  ```python
  # rag/llm_client.py
  from zhipuai import ZhipuAI

  class GLMClient:
      async def check_tag(conversation, ai_tag, relevant_tags):
          # 1. 构建 Prompt
          # 2. 调用 GLM-4
          # 3. 解析响应
  ```

- [ ] 测试 LLM 判断准确率
  - 准备 50 条测试数据
  - 对比人工判断结果

#### Day 16-17：RAG 引擎集成（2天）

- [ ] 实现完整 RAG 引擎
  ```python
  # rag/engine.py
  class RAGEngine:
      async def check_tag(conversation_text, ai_tag):
          # 1. 向量检索
          # 2. LLM 判断
          # 3. 返回结果
  ```

- [ ] 实现 RAG API
  ```
  POST /api/v1/rag/check
  ```

- [ ] 添加缓存（Redis）
  ```python
  # 缓存 RAG 结果，避免重复调用
  ```

#### 验收标准
- ✅ 向量库构建成功，56 个标签全部索引
- ✅ 检索准确率 > 80%（Top 5）
- ✅ LLM 判断准确率 > 85%
- ✅ RAG API 响应时间 < 3 秒

---

## 🔗 第 4 周：前后端集成（2月3日 - 2月9日）

### 目标
将 RAG 引擎集成到前端，实现完整的 MVP。

### 任务清单

#### Day 18-19：API 对接（2天）

- [ ] 前端集成 RAG API
  ```typescript
  // hooks/useRAGCheck.ts
  export function useRAGCheck() {
    return useMutation({
      mutationFn: async (params) => {
        const res = await fetch('/api/v1/rag/check', {
          method: 'POST',
          body: JSON.stringify(params)
        })
        return res.json()
      }
    })
  }
  ```

- [ ] 显示 RAG 推荐结果
  - 置信度显示（进度条）
  - Top 3 推荐标签
  - 推理过程（可展开）

#### Day 20：快捷键实现（1天）

- [ ] 安装快捷键库
  ```bash
  npm install react-hotkeys-hook
  ```

- [ ] 实现快捷键逻辑
  ```typescript
  // hooks/useKeyboardShortcuts.ts
  import { useHotkeys } from 'react-hotkeys-hook'

  export function useKeyboardShortcuts() {
    // 空格：确认
    useHotkeys('space', () => {
      approveAI()
    })

    // 1-3：选择推荐
    useHotkeys('1', () => selectRecommendation(0))
    useHotkeys('2', () => selectRecommendation(1))
    useHotkeys('3', () => selectRecommendation(2))

    // Enter：跳过
    useHotkeys('enter', () => {
      skipConversation()
    })
  }
  ```

- [ ] 添加快捷键提示
  - 在界面显示快捷键说明
  - 首次使用时显示引导

#### Day 21：预加载优化（1天）

- [ ] 实现下一条预加载
  ```typescript
  // hooks/usePrefetch.ts
  export function usePrefetch(currentId: number) {
    const queryClient = useQueryClient()

    useEffect(() => {
      // 预加载下一条
      const nextId = currentId + 1
      queryClient.prefetchQuery({
        queryKey: ['conversation', nextId],
        queryFn: () => fetchConversation(nextId)
      })
    }, [currentId])
  }
  ```

#### Day 22-23：端到端测试（2天）

- [ ] 功能测试
  - [ ] 导入 Excel
  - [ ] 审核对话（确认/修改/跳过）
  - [ ] RAG 推荐
  - [ ] 快捷键操作
  - [ ] 导出结果

- [ ] 性能测试
  - [ ] API 响应时间
  - [ ] 前端渲染性能
  - [ ] RAG 推荐速度

- [ ] 修复 Bug

#### 验收标准
- ✅ 完整审核流程可用
- ✅ RAG 推荐正常显示
- ✅ 快捷键正常工作
- ✅ 预加载生效，体验流畅

---

## ✨ 第 5 周：优化完善（2月10日 - 2月16日）

### 目标
性能优化、体验提升、疑难案例功能。

### 任务清单

#### Day 24-25：性能优化（2天）

- [ ] 后端优化
  - [ ] 添加 Redis 缓存
  - [ ] 批量处理嵌入向量
  - [ ] 优化数据库查询（索引）
  - [ ] 异步处理（asyncio）

- [ ] 前端优化
  - [ ] 代码分割（动态导入）
  - [ ] 懒加载组件
  - [ ] 优化 re-render（useMemo、useCallback）
  - [ ] 虚拟滚动（如果列表很长）

#### Day 26-27：体验优化（2天）

- [ ] 标签定义浮窗
  ```typescript
  // 鼠标悬停显示标签定义
  <Tooltip content={tag.definition}>
    <Badge>{tag.name}</Badge>
  </Tooltip>
  ```

- [ ] 选中文字搜索标签
  ```typescript
  // 用户选中对话文字，自动搜索相关标签
  document.addEventListener('selectionchange', () => {
    const selection = window.getSelection().toString().trim()
    if (selection) {
      searchRelatedTags(selection)
    }
  })
  ```

- [ ] 进度管理
  - 显示已审核/未审核/存疑数量
  - 审核进度条
  - 预计剩余时间

#### Day 28-29：疑难案例功能（2天）

- [ ] 疑难案例标记
  - 审核人员可标记"疑难"
  - 记录到数据库

- [ ] 疑难案例知识库
  - 收集历史疑难案例
  - 向量化存储
  - 推荐相似案例

#### Day 30：UI/UX 优化（1天）

- [ ] 设计优化
  - 调整间距、圆角
  - 优化颜色对比度
  - 添加过渡动画

- [ ] 响应式适配
  - 支持不同分辨率
  - 笔记本适配

#### 验收标准
- ✅ API 响应时间 < 500ms（P95）
- ✅ 前端首屏加载 < 2s
- ✅ RAG 推荐 < 3s
- ✅ 用户体验流畅

---

## 🚀 第 6 周：测试上线（2月17日 - 2月23日）

### 目标
完整测试、编写文档、部署上线。

### 任务清单

#### Day 31-32：完整测试（2天）

- [ ] 功能测试
  - [ ] 数据导入（Excel）
  - [ ] 对话展示（气泡、高亮）
  - [ ] 标签操作（选择、提交）
  - [ ] RAG 推荐（准确性）
  - [ ] 快捷键（所有操作）
  - [ ] 数据导出（Excel）

- [ ] 性能测试
  - [ ] 并发测试（10 人同时使用）
  - [ ] 压力测试（3500 条数据）
  - [ ] 长时间运行（内存泄漏）

- [ ] 兼容性测试
  - [ ] Chrome
  - [ ] Firefox
  - [ ] Safari
  - [ ] Edge

#### Day 33-34：编写文档（2天）

- [ ] 用户文档
  - 安装指南
  - 快速开始
  - 功能说明
  - 常见问题

- [ ] 开发文档
  - 项目结构
  - API 文档
  - 数据库设计
  - RAG 引擎说明

- [ ] 运维文档
  - 部署指南
  - 监控告警
  - 备份恢复
  - 故障排查

#### Day 35：部署上线（1天）

- [ ] Docker 部署
  ```bash
  # 构建镜像
  docker-compose build

  # 启动服务
  docker-compose up -d
  ```

- [ ] 数据准备
  - 导入 1.xlsx
  - 构建向量库
  - 验证数据

- [ ] 线上验证
  - 访问测试
  - 功能验证
  - 性能监控

#### Day 36：收集反馈（1天）

- [ ] 邀请测试用户
- [ ] 收集反馈
- [ ] 记录问题

#### 验收标准
- ✅ 所有功能测试通过
- ✅ 性能指标达标
- ✅ 文档完整
- ✅ 成功部署上线

---

## 📊 里程碑和交付物

### Milestone 1：基础框架（第 1 周）
**交付物**：
- ✅ 前后端项目代码
- ✅ 数据库表结构
- ✅ Excel 数据导入脚本

**验收标准**：
- 能成功导入 3500 条对话数据
- API 能正常返回对话列表

### Milestone 2：核心功能（第 2 周）
**交付物**：
- ✅ 对话气泡组件
- ✅ 标签选择器
- ✅ 完整的 CRUD API

**验收标准**：
- 能完成完整的审核流程
- 单条审核时间 < 1 分钟

### Milestone 3：RAG 引擎（第 3 周）
**交付物**：
- ✅ 向量库（56 个标签）
- ✅ 混合检索器
- ✅ LLM 判断器

**验收标准**：
- RAG 准确率 > 85%
- API 响应时间 < 3 秒

### Milestone 4：MVP 完成（第 4 周）
**交付物**：
- ✅ 完整可用的系统
- ✅ 快捷键支持
- ✅ RAG 推荐显示

**验收标准**：
- 单条审核时间 < 30 秒
- 用户体验流畅

### Milestone 5：优化版本（第 5 周）
**交付物**：
- ✅ 性能优化版本
- ✅ 疑难案例功能
- ✅ UI/UX 优化

**验收标准**：
- API 响应 < 500ms
- RAG 准确率 > 90%

### Milestone 6：正式上线（第 6 周）
**交付物**：
- ✅ 部署包（Docker）
- ✅ 用户文档
- ✅ 开发文档

**验收标准**：
- 成功部署
- 用户可以使用

---

## 🎯 成功指标

### 效率指标
| 指标 | 目标 | 测量方式 |
|------|------|----------|
| 单条审核时间 | < 30 秒 | 记录审核日志 |
| 总审核时间 | < 6 小时 | 3500 条 ÷ 单条时间 |
| RAG 准确率 | > 90% | 对比人工审核结果 |

### 质量指标
| 指标 | 目标 | 测量方式 |
|------|------|----------|
| 人工审核准确率 | ≥ 95% | 抽样检查 |
| API 错误率 | < 1% | 日志监控 |
| 前端 Bug 数 | < 5 个 | 用户反馈 |

### 性能指标
| 指标 | 目标 | 测量方式 |
|------|------|----------|
| API 响应时间 | < 500ms (P95) | APM 监控 |
| 前端首屏加载 | < 2s | Lighthouse |
| RAG 推荐时间 | < 3s | 日志记录 |

---

## 🚨 风险管理

### 技术风险

| 风险 | 可能性 | 影响 | 应对措施 |
|------|--------|------|----------|
| GLM-4 API 不稳定 | 中 | 高 | 添加降级方案，使用本地模型 |
| 向量检索准确率低 | 中 | 中 | 优化检索策略，混合 BM25 |
| 前端性能问题 | 低 | 中 | 代码分割、懒加载 |

### 进度风险

| 风险 | 可能性 | 影响 | 应对措施 |
|------|--------|------|----------|
| RAG 开发延期 | 中 | 高 | 先上线基础版，RAG 后续加 |
| 测试时间不足 | 中 | 中 | 每周进行集成测试 |
| 人员变动 | 低 | 高 | 代码文档化，知识分享 |

---

**最后更新**: 2025-01-13
**维护者**: Smart Labeling Workbench Team
**项目周期**: 6 周（2025-01-13 ~ 2025-02-23）
