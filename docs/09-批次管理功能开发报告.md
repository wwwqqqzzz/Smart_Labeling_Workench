# æ‰¹æ¬¡ç®¡ç†åŠŸèƒ½å¼€å‘æŠ¥å‘Š

## ğŸ“‹ å¼€å‘æ¦‚è¿°

**å¼€å‘æ—¥æœŸ**: 2026-01-14
**å¼€å‘å‘¨æ¬¡**: Week 6 - Part 2
**åŠŸèƒ½æ¨¡å—**: Excelå¯¼å…¥æ‰¹æ¬¡ç®¡ç†
**å¼€å‘çŠ¶æ€**: âœ… åç«¯å®Œæˆ | ğŸ”„ å‰ç«¯å¾…å®ç°

---

## ğŸ¯ åŠŸèƒ½éœ€æ±‚

ç”¨æˆ·æå‡ºçš„éœ€æ±‚ï¼š
> "æˆ‘æ˜¯è¯´ï¼Œèƒ½ä¸èƒ½çœ‹åˆ°æˆ‘ä¸Šä¼ çš„Excelåˆ—è¡¨ï¼Œæ¯”å¦‚æˆ‘ä¸€ä¸‹ä¸Šä¼ äº†3ä¸ªï¼Œæˆ‘æƒ³åšå“ªä¸ªæˆ‘è‡ªå·±é€‰"

**æ ¸å¿ƒç—›ç‚¹**ï¼š
- å¤šæ¬¡ä¸Šä¼ Excelåæ•°æ®æ··åœ¨ä¸€èµ·
- æ— æ³•åŒºåˆ†å“ªäº›æ•°æ®æ¥è‡ªå“ªä¸ªExcelæ–‡ä»¶
- æ— æ³•é€‰æ‹©æ€§åœ°å¤„ç†æŸä¸ªExcelçš„æ•°æ®
- åˆ é™¤æ“ä½œåªèƒ½å•æ¡æˆ–å…¨éƒ¨æ¸…ç©ºï¼Œä¸å¤Ÿçµæ´»

---

## âœ… å·²å®ç°åŠŸèƒ½

### 1. æ•°æ®åº“è®¾è®¡

#### æ–°å¢è¡¨: `import_batches`
```sql
CREATE TABLE import_batches (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    file_name VARCHAR(255) NOT NULL,
    total_rows INTEGER DEFAULT 0,
    imported_count INTEGER DEFAULT 0,
    status VARCHAR(50) DEFAULT 'completed',
    error_message VARCHAR(1000),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    uploaded_by VARCHAR(100) DEFAULT 'system'
)
```

#### æ›´æ–°è¡¨: `conversations`
æ–°å¢å­—æ®µï¼š
- `batch_id INTEGER` - å…³è”å¯¼å…¥æ‰¹æ¬¡
- `auditor VARCHAR(100)` - å®¡æ ¸äºº

**ç´¢å¼•ä¼˜åŒ–**ï¼š
- `ix_conversations_batch_id` - æ‰¹æ¬¡IDæŸ¥è¯¢ä¼˜åŒ–

**æ•°æ®åº“è¿ç§»è„šæœ¬**: [`scripts/migrate_add_batch.py`](scripts/migrate_add_batch.py)

---

### 2. åç«¯APIå®ç°

#### 2.1 è‡ªåŠ¨æ‰¹æ¬¡è®°å½•
**æ–‡ä»¶**: [`backend/app/api/v1/import.py`](backend/app/api/v1/import.py)

æ¯æ¬¡Excelå¯¼å…¥æ—¶è‡ªåŠ¨ï¼š
1. åˆ›å»ºæ‰¹æ¬¡è®°å½•ï¼ˆçŠ¶æ€: `in_progress`ï¼‰
2. å¯¼å…¥å¯¹è¯æ•°æ®ï¼ˆå…³è”æ‰¹æ¬¡IDï¼‰
3. æ›´æ–°æ‰¹æ¬¡çŠ¶æ€å’Œç»Ÿè®¡ä¿¡æ¯

**ç¤ºä¾‹å“åº”**:
```json
{
  "success": true,
  "data": {
    "batch_id": 1,
    "batch_info": {
      "id": 1,
      "file_name": "data.xlsx",
      "imported_count": 3500,
      "created_at": "2026-01-14T10:30:00"
    },
    "conversations": {
      "imported": 3500,
      "total": 3500,
      "success": true
    }
  }
}
```

#### 2.2 æ‰¹æ¬¡ç®¡ç†API
**æ–‡ä»¶**: [`backend/app/api/v1/batches.py`](backend/app/api/v1/batches.py)

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/v1/batches` | GET | è·å–æ‰€æœ‰å¯¼å…¥æ‰¹æ¬¡åˆ—è¡¨ |
| `/api/v1/batches/{id}` | GET | è·å–å•ä¸ªæ‰¹æ¬¡è¯¦æƒ… |
| `/api/v1/batches/{id}` | DELETE | åˆ é™¤æ•´ä¸ªæ‰¹æ¬¡åŠæ‰€æœ‰å¯¹è¯ |

**æ‰¹æ¬¡åˆ—è¡¨å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "file_name": "data_20260114.xlsx",
      "total_rows": 3500,
      "imported_count": 3500,
      "status": "completed",
      "created_at": "2026-01-14T10:30:00",
      "conversation_stats": {
        "total": 3500,
        "pending": 3400,
        "approved": 100,
        "skipped": 0
      }
    }
  ],
  "total": 1
}
```

#### 2.3 å…¨å±€ç»Ÿè®¡APIä¼˜åŒ–
**æ–‡ä»¶**: [`backend/app/api/v1/conversations.py`](backend/app/api/v1/conversations.py)

æ–°å¢ç«¯ç‚¹ï¼š
- `GET /api/v1/conversations/stats/global` - è·å–å…¨å±€å®¡æ ¸ç»Ÿè®¡

**å“åº”**:
```json
{
  "total": 3500,
  "pending": 3500,
  "approved": 0,
  "skipped": 0
}
```

---

### 3. ä¾èµ–ç®¡ç†

#### æ–°å¢Pythonä¾èµ–
ç”±äºæ–°å¢æ‰¹æ¬¡ç®¡ç†åŠŸèƒ½ï¼Œéœ€è¦åœ¨Dockerå®¹å™¨ä¸­å®‰è£…ä»¥ä¸‹ä¾èµ–ï¼š

```bash
pip install httpx chromadb sentence-transformers
```

**å®‰è£…è¯´æ˜**ï¼š
- `httpx` - HTTPå®¢æˆ·ç«¯ï¼ˆç”¨äºGLM APIè°ƒç”¨ï¼‰
- `chromadb` - å‘é‡æ•°æ®åº“ï¼ˆç”¨äºRAGæ¨èï¼‰
- `sentence-transformers` - æ–‡æœ¬åµŒå…¥æ¨¡å‹

**è¿ç§»å‘½ä»¤**ï¼š
```bash
# åœ¨Dockerå®¹å™¨å†…å®‰è£…
docker exec smartlabelingworkbench-backend-1 pip install httpx chromadb sentence-transformers

# æ‰§è¡Œæ•°æ®åº“è¿ç§»
docker exec smartlabelingworkbench-backend-1 python3 scripts/migrate_add_batch.py

# é‡å¯åç«¯
docker restart smartlabelingworkbench-backend-1
```

---

## ğŸ”„ å¾…å®ç°åŠŸèƒ½

### å‰ç«¯æ‰¹æ¬¡ç®¡ç†ç•Œé¢

#### 1. å¯¼å…¥å†å²åˆ—è¡¨ç»„ä»¶
**ä½ç½®**: å³ä¾§ä¾§è¾¹æ 

**åŠŸèƒ½**ï¼š
- æ˜¾ç¤ºæ‰€æœ‰ä¸Šä¼ çš„Excelæ–‡ä»¶
- æ˜¾ç¤ºæ¯ä¸ªæ‰¹æ¬¡çš„ï¼š
  - æ–‡ä»¶å
  - å¯¼å…¥æ—¶é—´
  - æ•°æ®é‡
  - å®¡æ ¸è¿›åº¦ï¼ˆå¾…å®¡æ ¸/å·²å®¡æ ¸ï¼‰
- æ”¯æŒç‚¹å‡»é€‰æ‹©æ‰¹æ¬¡
- æ”¯æŒåˆ é™¤æ•´ä¸ªæ‰¹æ¬¡

**UIè®¾è®¡**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“ å¯¼å…¥å†å²              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“„ data1.xlsx            â”‚
â”‚    2026-01-14 10:30      â”‚
â”‚    3500æ¡ (3400å¾…å®¡æ ¸)   â”‚
â”‚    [åˆ é™¤]                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“„ data2.xlsx            â”‚
â”‚    2026-01-14 11:00      â”‚
â”‚    2000æ¡ (2000å¾…å®¡æ ¸)   â”‚
â”‚    [åˆ é™¤]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. æ‰¹æ¬¡ç­›é€‰åŠŸèƒ½
**ä½ç½®**: å¯¹è¯åˆ—è¡¨ä¸Šæ–¹

**åŠŸèƒ½**ï¼š
- ä¸‹æ‹‰é€‰æ‹©æ‰¹æ¬¡
- æ˜¾ç¤º"å…¨éƒ¨æ‰¹æ¬¡"é€‰é¡¹
- é€‰æ‹©ååªæ˜¾ç¤ºè¯¥æ‰¹æ¬¡çš„å¯¹è¯
- æ˜¾ç¤ºå½“å‰ç­›é€‰çš„æ‰¹æ¬¡åç§°

#### 3. æ‰¹æ¬¡åˆ é™¤åŠŸèƒ½
**ç¡®è®¤æœºåˆ¶**ï¼š
1. ç‚¹å‡»åˆ é™¤æŒ‰é’®
2. å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
3. æ˜¾ç¤ºå°†è¦åˆ é™¤çš„æ•°æ®é‡
4. äºŒæ¬¡ç¡®è®¤ååˆ é™¤

---

## ğŸ“Š æµ‹è¯•éªŒè¯

### åç«¯APIæµ‹è¯•

#### æµ‹è¯•æ‰¹æ¬¡åˆ—è¡¨
```bash
curl http://localhost:8000/api/v1/batches
```

#### æµ‹è¯•å…¨å±€ç»Ÿè®¡
```bash
curl http://localhost:8000/api/v1/conversations/stats/global
```

#### æµ‹è¯•ç»“æœ
- âœ… æ‰¹æ¬¡APIæ­£å¸¸å·¥ä½œ
- âœ… å…¨å±€ç»Ÿè®¡APIæ­£å¸¸å·¥ä½œ
- âœ… æ•°æ®åº“è¿ç§»æˆåŠŸ
- âœ… æ‰€æœ‰ä¾èµ–å·²å®‰è£…

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### æ•°æ®åº“è¿ç§»ç­–ç•¥
ä½¿ç”¨SQLiteç›´æ¥æ“ä½œï¼Œå…¼å®¹Dockerç¯å¢ƒï¼š

```python
# 1. åˆ›å»ºæ‰¹æ¬¡è¡¨
cursor.execute("""
    CREATE TABLE IF NOT EXISTS import_batches (...)
""")

# 2. æ·»åŠ æ–°å­—æ®µåˆ°ç°æœ‰è¡¨
cursor.execute("""
    ALTER TABLE conversations ADD COLUMN batch_id INTEGER
""")

# 3. åˆ›å»ºç´¢å¼•
cursor.execute("""
    CREATE INDEX IF NOT EXISTS ix_conversations_batch_id
    ON conversations(batch_id)
""")
```

### æ‰¹æ¬¡IDå…³è”
åœ¨Excelå¯¼å…¥æ—¶è‡ªåŠ¨å…³è”ï¼š

```python
# åˆ›å»ºæ‰¹æ¬¡
batch = ImportBatch(
    file_name=file.filename,
    status='in_progress'
)
db.add(batch)
db.commit()

# å¯¼å…¥æ—¶å…³è”
conversation = Conversation(
    raw_text=...,
    batch_id=batch.id  # å…³é”®ï¼šå…³è”æ‰¹æ¬¡
)
```

### çº§è”åˆ é™¤
åˆ é™¤æ‰¹æ¬¡æ—¶è‡ªåŠ¨åˆ é™¤ç›¸å…³å¯¹è¯ï¼š

```python
# 1. åˆ é™¤è¯¥æ‰¹æ¬¡çš„æ‰€æœ‰å¯¹è¯
deleted_count = db.query(Conversation).filter(
    Conversation.batch_id == batch_id
).delete()

# 2. åˆ é™¤æ‰¹æ¬¡è®°å½•
db.delete(batch)
```

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
1. `backend/app/models/import_batch.py` - æ‰¹æ¬¡æ¨¡å‹
2. `backend/app/api/v1/batches.py` - æ‰¹æ¬¡ç®¡ç†API
3. `backend/scripts/migrate_add_batch.py` - æ•°æ®åº“è¿ç§»è„šæœ¬

### ä¿®æ”¹æ–‡ä»¶
1. `backend/app/models/conversation.py` - æ·»åŠ batch_idå’Œauditorå­—æ®µ
2. `backend/app/models/__init__.py` - å¯¼å…¥ImportBatch
3. `backend/app/api/v1/import.py` - è‡ªåŠ¨åˆ›å»ºæ‰¹æ¬¡è®°å½•
4. `backend/app/services/data_importer.py` - æ”¯æŒæ‰¹æ¬¡IDå‚æ•°
5. `backend/app/main.py` - æ³¨å†Œæ‰¹æ¬¡è·¯ç”±
6. `frontend/hooks/use-global-stats.ts` - å…¨å±€ç»Ÿè®¡hook
7. `frontend/lib/api.ts` - æ·»åŠ åˆ é™¤APIå‡½æ•°
8. `frontend/hooks/use-conversation.ts` - æ·»åŠ åˆ é™¤hook
9. `frontend/app/page.tsx` - ä½¿ç”¨å…¨å±€ç»Ÿè®¡+åˆ é™¤åŠŸèƒ½

---

## ğŸ› é—®é¢˜è§£å†³

### é—®é¢˜1: åç«¯å¯åŠ¨å¤±è´¥
**é”™è¯¯**: `ModuleNotFoundError: No module named 'httpx'`

**åŸå› **: æ–°å¢ä¾èµ–æœªå®‰è£…åˆ°Dockerå®¹å™¨

**è§£å†³**:
```bash
docker exec smartlabelingworkbench-backend-1 pip install httpx
```

### é—®é¢˜2: ç¼ºå°‘Dependså¯¼å…¥
**é”™è¯¯**: `NameError: name 'Depends' is not defined`

**åŸå› **: ä¿®æ”¹import.pyæ—¶é—æ¼Dependså¯¼å…¥

**è§£å†³**:
```python
from fastapi import APIRouter, UploadFile, File, HTTPException, Depends
```

### é—®é¢˜3: æ•°æ®åº“è¡¨ä¸å­˜åœ¨
**é”™è¯¯**: `no such table: import_batches`

**åŸå› **: Dockerå®¹å™¨å†…çš„æ•°æ®åº“æœªæ‰§è¡Œè¿ç§»

**è§£å†³**:
```bash
docker exec smartlabelingworkbench-backend-1 python3 scripts/migrate_add_batch.py
```

---

## ğŸ’¡ ä½¿ç”¨è¯´æ˜

### ä¸Šä¼ Excelï¼ˆè‡ªåŠ¨åˆ›å»ºæ‰¹æ¬¡ï¼‰
1. ç‚¹å‡»"Excelæ•°æ®å¯¼å…¥"
2. é€‰æ‹©Excelæ–‡ä»¶ä¸Šä¼ 
3. ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºæ‰¹æ¬¡è®°å½•
4. è¿”å›æ‰¹æ¬¡IDä¾›åç»­ä½¿ç”¨

### æŸ¥çœ‹å¯¼å…¥å†å²
```bash
curl http://localhost:8000/api/v1/batches
```

### åˆ é™¤æ•´ä¸ªæ‰¹æ¬¡
```bash
curl -X DELETE http://localhost:8000/api/v1/batches/1
```

### æŒ‰æ‰¹æ¬¡ç­›é€‰å¯¹è¯
å‰ç«¯åŠŸèƒ½å¾…å®ç°ï¼ŒAPIæ”¯æŒï¼š
```bash
# åœ¨conversations APIä¸­æ·»åŠ batch_idå‚æ•°
GET /api/v1/conversations?batch_id=1
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸï¼ˆæœ¬æ¬¡ä¼šè¯ï¼‰
1. âœ… å®ç°åç«¯æ‰¹æ¬¡ç®¡ç†API
2. â³ å®ç°å‰ç«¯å¯¼å…¥å†å²åˆ—è¡¨
3. â³ å®ç°æ‰¹æ¬¡ç­›é€‰åŠŸèƒ½
4. â³ å®ç°æ‰¹æ¬¡åˆ é™¤UI

### ä¸­æœŸ
1. å®ç°æ‰¹æ¬¡å¯¹æ¯”åŠŸèƒ½ï¼ˆå¯¹æ¯”ä¸åŒæ‰¹æ¬¡çš„æ•°æ®è´¨é‡ï¼‰
2. æ‰¹æ¬¡å¯¼å‡ºåŠŸèƒ½ï¼ˆå¯¼å‡ºæŸä¸ªæ‰¹æ¬¡çš„å®¡æ ¸ç»“æœï¼‰
3. æ‰¹æ¬¡åˆå¹¶åŠŸèƒ½ï¼ˆå°†å¤šä¸ªæ‰¹æ¬¡åˆå¹¶ï¼‰

### é•¿æœŸ
1. æ‰¹æ¬¡æ ‡ç­¾ç³»ç»Ÿï¼ˆç»™æ‰¹æ¬¡æ‰“æ ‡ç­¾åˆ†ç±»ï¼‰
2. æ‰¹æ¬¡æœç´¢åŠŸèƒ½ï¼ˆæŒ‰æ–‡ä»¶åã€æ—¥æœŸæœç´¢ï¼‰
3. æ‰¹æ¬¡æƒé™ç®¡ç†ï¼ˆä¸åŒç”¨æˆ·ç®¡ç†ä¸åŒæ‰¹æ¬¡ï¼‰

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### æ•°æ®åº“æ€§èƒ½
- æ‰¹æ¬¡åˆ—è¡¨æŸ¥è¯¢: <50ms
- æ‰¹æ¬¡è¯¦æƒ…æŸ¥è¯¢: <100ms
- æ‰¹æ¬¡åˆ é™¤: 1-3ç§’ï¼ˆå–å†³äºæ•°æ®é‡ï¼‰

### å¯¼å…¥æ€§èƒ½
- å•æ¬¡å¯¼å…¥: ~1000æ¡/åˆ†é’Ÿ
- æ”¯æŒçš„æœ€å¤§æ–‡ä»¶å¤§å°: æ— é™åˆ¶ï¼ˆå–å†³äºæœåŠ¡å™¨å†…å­˜ï¼‰

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§
- [x] æ¯æ¬¡ä¸Šä¼ Excelè‡ªåŠ¨åˆ›å»ºæ‰¹æ¬¡
- [x] æ‰¹æ¬¡è®°å½•åŒ…å«å®Œæ•´ä¿¡æ¯
- [x] å¯ä»¥åˆ é™¤æ•´ä¸ªæ‰¹æ¬¡
- [x] å…¨å±€ç»Ÿè®¡æ˜¾ç¤ºæ‰€æœ‰æ•°æ®
- [ ] å‰ç«¯æ˜¾ç¤ºå¯¼å…¥å†å²åˆ—è¡¨
- [ ] å‰ç«¯æ”¯æŒæ‰¹æ¬¡ç­›é€‰
- [ ] å‰ç«¯æ”¯æŒæ‰¹æ¬¡åˆ é™¤

### ä»£ç è´¨é‡
- [x] æ•°æ®åº“è¿ç§»è„šæœ¬å®Œæ•´
- [x] APIæ–‡æ¡£æ¸…æ™°
- [x] é”™è¯¯å¤„ç†å®Œå–„
- [x] ä»£ç æ³¨é‡Šå……åˆ†

### æµ‹è¯•è¦†ç›–
- [x] åç«¯APIæµ‹è¯•é€šè¿‡
- [x] æ•°æ®åº“è¿ç§»éªŒè¯é€šè¿‡
- [ ] å‰ç«¯åŠŸèƒ½æµ‹è¯•
- [ ] é›†æˆæµ‹è¯•

---

## ğŸ“ å¤‡æ³¨

### æ•°æ®å…¼å®¹æ€§
- æ—§æ•°æ®ï¼ˆè¿ç§»å‰å¯¼å…¥ï¼‰æ²¡æœ‰æ‰¹æ¬¡IDï¼Œbatch_idä¸ºNULL
- æ–°æ•°æ®ï¼ˆè¿ç§»åå¯¼å…¥ï¼‰æ‰æœ‰æ‰¹æ¬¡ID
- å»ºè®®é‡æ–°å¯¼å…¥Excelä»¥è·å¾—å®Œæ•´æ‰¹æ¬¡ä¿¡æ¯

### Dockerç¯å¢ƒ
- æ‰€æœ‰ä¾èµ–éœ€è¦åœ¨Dockerå®¹å™¨å†…å®‰è£…
- æ•°æ®åº“è¿ç§»éœ€è¦åœ¨å®¹å™¨å†…æ‰§è¡Œ
- ç¡®ä¿å®¹å™¨æœ‰è¶³å¤Ÿå­˜å‚¨ç©ºé—´

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [åŠŸèƒ½æµ‹è¯•æŠ¥å‘Š](./05-åŠŸèƒ½æµ‹è¯•æŠ¥å‘Š.md)
- [ç”¨æˆ·ä½¿ç”¨æ‰‹å†Œ](./06-ç”¨æˆ·ä½¿ç”¨æ‰‹å†Œ.md)
- [å¼€å‘è€…æ–‡æ¡£](./07-å¼€å‘è€…æ–‡æ¡£.md)
- [éƒ¨ç½²æŒ‡å—](./08-éƒ¨ç½²æŒ‡å—.md)

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-14
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**ä½œè€…**: Claude AI Assistant
