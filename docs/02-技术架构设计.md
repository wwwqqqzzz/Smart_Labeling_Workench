# æŠ€æœ¯æ¶æ„è®¾è®¡

## ğŸ“ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         è¡¨ç°å±‚ (Presentation)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  å¯¹è¯å±•ç¤ºç»„ä»¶    â”‚              â”‚  æ ‡ç­¾æ“ä½œç»„ä»¶    â”‚         â”‚
â”‚  â”‚  - æ°”æ³¡æ¸²æŸ“      â”‚              â”‚  - å¿«æ·é”®æ”¯æŒ    â”‚         â”‚
â”‚  â”‚  - å…³é”®è¯é«˜äº®    â”‚              â”‚  - æ ‡ç­¾é€‰æ‹©å™¨    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†• HTTP/WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åº”ç”¨å±‚ (Application)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å¯¹è¯ç®¡ç†æœåŠ¡    â”‚  â”‚ RAG æ¨èæœåŠ¡ â”‚  â”‚  æ ‡ç­¾ç®¡ç†æœåŠ¡    â”‚  â”‚
â”‚  â”‚  - æ•°æ®å¯¼å…¥      â”‚  â”‚ - å‘é‡æ£€ç´¢   â”‚  â”‚  - æ ‡ç­¾åˆ†ç±»      â”‚  â”‚
â”‚  â”‚  - è¿›åº¦è¿½è¸ª      â”‚  â”‚ - LLM åˆ¤æ–­   â”‚  â”‚  - å®šä¹‰æŸ¥è¯¢      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ•°æ®å±‚ (Data)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ SQLite       â”‚  â”‚ Chroma DB    â”‚  â”‚ Redis Cache      â”‚      â”‚
â”‚  â”‚ - å¯¹è¯æ•°æ®    â”‚  â”‚ - å‘é‡ç´¢å¼•   â”‚  â”‚ - æ¨èç»“æœç¼“å­˜   â”‚      â”‚
â”‚  â”‚ - æ ‡ç­¾æ•°æ®    â”‚  â”‚ - è¯­ä¹‰æ£€ç´¢   â”‚  â”‚ - ä¼šè¯çŠ¶æ€       â”‚      â”‚
â”‚  â”‚ - å®¡æ ¸è®°å½•    â”‚  â”‚              â”‚  â”‚                  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¤–éƒ¨æœåŠ¡ (External)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ GLM-4 API    â”‚              â”‚ OpenAI API       â”‚            â”‚
â”‚  â”‚ - æ ‡ç­¾åˆ¤æ–­    â”‚              â”‚ - åµŒå…¥ç”Ÿæˆ       â”‚            â”‚
â”‚  â”‚ - æ¨ç†ç”Ÿæˆ    â”‚              â”‚                  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ æ•°æ®æ¨¡å‹è®¾è®¡

### ER å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ conversationsâ”‚     â”‚    tags      â”‚     â”‚  audit_logs  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)      â”‚â”€â”€â”¬â”€â”€â”‚ id (PK)      â”‚     â”‚ id (PK)      â”‚
â”‚ raw_text     â”‚  â”‚  â”‚ name         â”‚     â”‚ conv_id (FK) â”‚
â”‚ driver_tag   â”‚  â””â”€â”€â”‚ category     â”‚     â”‚ ai_tag       â”‚
â”‚ manual_tag   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”‚ definition   â”‚     â”‚ manual_tag   â”‚
â”‚ status       â”‚     â”‚ created_at   â”‚     â”‚ is_correct   â”‚
â”‚ created_at   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ confidence   â”‚
â”‚ updated_at   â”‚                           â”‚ auditor      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚ created_at   â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¡¨ç»“æ„è¯¦è§£

#### 1. conversationsï¼ˆå¯¹è¯è¡¨ï¼‰

```sql
CREATE TABLE conversations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    raw_text TEXT NOT NULL,              -- åŸå§‹å¯¹è¯æ–‡æœ¬ï¼ˆ$_$ æ ¼å¼ï¼‰
    driver_tag TEXT,                     -- AI æ‰“çš„æ ‡ç­¾ï¼ˆJSON æ•°ç»„ï¼‰
    manual_tag TEXT,                     -- äººå·¥å®¡æ ¸çš„æ ‡ç­¾ï¼ˆJSON æ•°ç»„ï¼‰
    status VARCHAR(20) DEFAULT 'pending', -- çŠ¶æ€: pending/approved/skipped
    field_length INTEGER,                -- å¯¹è¯é•¿åº¦
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_status ON conversations(status);
CREATE INDEX idx_created_at ON conversations(created_at);
```

**å­—æ®µè¯´æ˜**ï¼š
- `raw_text`: åŸå§‹å¯¹è¯ï¼Œæ ¼å¼ï¼š`å¸æœºï¼šxxx$_$è´§ä¸»ï¼šxxx$_$...`
- `driver_tag`: AI æ ‡ç­¾ï¼ŒJSON æ ¼å¼ï¼š`["å°¾æ¿è½¦", "è£…å¸è´¹"]`
- `manual_tag`: äººå·¥æ ‡ç­¾ï¼Œæ ¼å¼åŒä¸Šï¼Œä¸ºç©ºè¡¨ç¤ºæœªå®¡æ ¸
- `status`:
  - `pending`: å¾…å®¡æ ¸
  - `approved`: å·²ç¡®è®¤
  - `skipped`: å·²è·³è¿‡ï¼ˆå­˜ç–‘ï¼‰

#### 2. tagsï¼ˆæ ‡ç­¾è¡¨ï¼‰

```sql
CREATE TABLE tags (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) UNIQUE NOT NULL,   -- æ ‡ç­¾åç§°
    category VARCHAR(50) NOT NULL,       -- åˆ†ç±»: è½¦å‹ç±»/è´¹ç”¨ç±»/è£…å¸ç±»ç­‰
    definition TEXT,                     -- æ ‡ç­¾å®šä¹‰ï¼ˆå¤‡æ³¨è¯´æ˜ï¼‰
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_category ON tags(category);
```

**æ ‡ç­¾åˆ†ç±»**ï¼š
- è½¦å‹ç±»ï¼ˆ14ä¸ªï¼‰ï¼šé¢åŒ…è½¦ã€é«˜æ ã€å¢è´§ã€å¹³æ¿ã€ä¾ç»´æŸ¯ã€é£ç¿¼è½¦ç­‰
- è´¹ç”¨ç±»ï¼ˆ7ä¸ªï¼‰ï¼šé«˜é€Ÿè´¹ã€è¿›å‡ºåœºè´¹ã€è£…å¸è´¹ã€ç­‰å¾…è´¹ç­‰
- è£…å¸ç±»ï¼ˆ6ä¸ªï¼‰ï¼šè£…å¸è´¹ã€æ¬è¿è£…å¸ã€æ­æŠŠæ‰‹ã€ä¸æ¬è¿ç­‰
- è½¦é—¨ç±»ï¼ˆ8ä¸ªï¼‰ï¼šä¾§é—¨å•å¼€ã€ä¾§é—¨åŒå¼€ã€ä¾§é—¨å…¨å¼€ç­‰
- å…¶ä»–ï¼ˆ21ä¸ªï¼‰ï¼šè·Ÿè½¦Xäººã€æ‹¼è½¦å•ã€é›¨å¸ƒã€ç»³å­ç­‰

#### 3. audit_logsï¼ˆå®¡æ ¸è®°å½•è¡¨ï¼‰

```sql
CREATE TABLE audit_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    conv_id INTEGER NOT NULL,            -- å…³è”å¯¹è¯ ID
    ai_tag TEXT NOT NULL,                -- AI æ ‡ç­¾ï¼ˆJSONï¼‰
    manual_tag TEXT,                     -- äººå·¥æ ‡ç­¾ï¼ˆJSONï¼‰
    is_correct BOOLEAN,                  -- æ˜¯å¦æ­£ç¡®
    confidence FLOAT,                    -- RAG ç½®ä¿¡åº¦
    recommendations TEXT,                -- RAG æ¨èï¼ˆJSONï¼‰
    auditor VARCHAR(50),                 -- å®¡æ ¸äºº
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (conv_id) REFERENCES conversations(id)
);

-- ç´¢å¼•
CREATE INDEX idx_conv_id ON audit_logs(conv_id);
CREATE INDEX idx_auditor ON audit_logs(auditor);
```

---

## ğŸ¤– RAG å¼•æ“æ¶æ„

### RAG å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: è¾“å…¥                                                â”‚
â”‚   å¯¹è¯æ–‡æœ¬ + AI æ ‡ç­¾                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: æ–‡æœ¬é¢„å¤„ç†                                          â”‚
â”‚   - è§£æå¯¹è¯æ°”æ³¡ï¼ˆå¸æœº/è´§ä¸»ï¼‰                                â”‚
â”‚   - æå–å…³é”®è¯ï¼ˆæ­£åˆ™åŒ¹é…ï¼‰                                   â”‚
â”‚   - æ¸…æ´—å™ªéŸ³ï¼ˆè¯­æ°”è¯ã€é‡å¤ï¼‰                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: å‘é‡æ£€ç´¢                                            â”‚
â”‚   3.1 å¯¹è¯æ–‡æœ¬åµŒå…¥ï¼ˆOpenAI embedding-3-smallï¼‰              â”‚
â”‚   3.2 åœ¨ Chroma ä¸­æ£€ç´¢ Top 5 ç›¸å…³æ ‡ç­¾å®šä¹‰                    â”‚
â”‚   3.3 è®¡ç®—ç›¸ä¼¼åº¦åˆ†æ•°                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: LLM åˆ¤æ–­                                            â”‚
â”‚   Prompt æ„å»º:                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ å¯¹è¯: {conversation_text}                            â”‚  â”‚
â”‚   â”‚ AI æ ‡ç­¾: {ai_tag}                                    â”‚  â”‚
â”‚   â”‚                                                       â”‚  â”‚
â”‚   â”‚ å‚è€ƒæ ‡ç­¾å®šä¹‰:                                         â”‚  â”‚
â”‚   â”‚ 1. å°¾æ¿è½¦: ...                                       â”‚  â”‚
â”‚   â”‚ 2. æ— å°¾æ¿: ...                                       â”‚  â”‚
â”‚   â”‚ 3. è£…å¸è´¹: ...                                       â”‚  â”‚
â”‚   â”‚                                                       â”‚  â”‚
â”‚   â”‚ è¯·åˆ¤æ–­ AI æ ‡ç­¾æ˜¯å¦æ­£ç¡®ï¼Ÿå¦‚æœä¸æ­£ç¡®ï¼Œåº”è¯¥é€‰å“ªä¸ªï¼Ÿ      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                           â”‚
â”‚   è°ƒç”¨ GLM-4 Flash API                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: ç»“æœè§£æ                                            â”‚
â”‚   {                                                        â”‚
â”‚     "is_correct": true,                                    â”‚
â”‚     "confidence": 0.92,                                    â”‚
â”‚     "recommendations": [                                   â”‚
â”‚       {"tag": "å°¾æ¿è½¦", "score": 0.92, "reason": "..."},   â”‚
â”‚       {"tag": "æ— å°¾æ¿", "score": 0.05, "reason": "..."}    â”‚
â”‚     ],                                                     â”‚
â”‚     "reasoning": "å¯¹è¯ä¸­æ˜ç¡®æåˆ°æœ‰å°¾æ¿..."                  â”‚
â”‚   }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### RAG å¼•æ“ä»£ç ç»“æ„

```
backend/
â”œâ”€â”€ rag/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ engine.py              # RAG å¼•æ“ä¸»é€»è¾‘
â”‚   â”œâ”€â”€ retriever.py           # å‘é‡æ£€ç´¢å™¨
â”‚   â”œâ”€â”€ judge.py               # LLM åˆ¤æ–­å™¨
â”‚   â””â”€â”€ prompts.py             # Prompt æ¨¡æ¿
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ conversation_service.py
â”‚   â”œâ”€â”€ tag_service.py
â”‚   â””â”€â”€ audit_service.py
â””â”€â”€ models/
    â”œâ”€â”€ conversation.py
    â”œâ”€â”€ tag.py
    â””â”€â”€ audit_log.py
```

### å…³é”®æ¨¡å—è®¾è®¡

#### 1. RAG Engineï¼ˆå¼•æ“ï¼‰

```python
# rag/engine.py
class RAGEngine:
    """RAG æ¨èå¼•æ“"""

    def __init__(
        self,
        vector_store: Chroma,
        llm: GLM4,
        cache_client: Optional[Redis] = None
    ):
        self.vector_store = vector_store
        self.llm = llm
        self.cache = cache_client

    async def check_tag(
        self,
        conversation_text: str,
        ai_tag: str
    ) -> RAGResult:
        """
        æ£€æŸ¥ AI æ ‡ç­¾æ˜¯å¦æ­£ç¡®

        Args:
            conversation_text: å¯¹è¯æ–‡æœ¬
            ai_tag: AI æ‰“çš„æ ‡ç­¾

        Returns:
            RAGResult: åˆ¤æ–­ç»“æœ
        """
        # 1. æ£€æŸ¥ç¼“å­˜
        cache_key = f"rag:{md5(conversation_text)}:{ai_tag}"
        if cached := await self.cache.get(cache_key):
            return RAGResult.parse_raw(cached)

        # 2. å‘é‡æ£€ç´¢
        relevant_tags = await self.retriever.retrieve(
            query=conversation_text,
            top_k=5
        )

        # 3. LLM åˆ¤æ–­
        llm_response = await self.judge.judge(
            conversation_text=conversation_text,
            ai_tag=ai_tag,
            relevant_tags=relevant_tags
        )

        # 4. æ„å»ºç»“æœ
        result = RAGResult(
            is_correct=llm_response.is_correct,
            confidence=llm_response.confidence,
            recommendations=llm_response.recommendations,
            reasoning=llm_response.reasoning
        )

        # 5. ç¼“å­˜ç»“æœ
        await self.cache.set(
            cache_key,
            result.json(),
            ex=3600  # 1 å°æ—¶è¿‡æœŸ
        )

        return result
```

#### 2. Retrieverï¼ˆæ£€ç´¢å™¨ï¼‰

```python
# rag/retriever.py
class VectorRetriever:
    """å‘é‡æ£€ç´¢å™¨"""

    def __init__(
        self,
        vector_store: Chroma,
        embedding_model: OpenAIEmbeddings
    ):
        self.vector_store = vector_store
        self.embedding_model = embedding_model

    async def retrieve(
        self,
        query: str,
        top_k: int = 5
    ) -> List[TagDefinition]:
        """
        æ£€ç´¢ç›¸å…³æ ‡ç­¾å®šä¹‰

        Args:
            query: æŸ¥è¯¢æ–‡æœ¬
            top_k: è¿”å› Top K

        Returns:
            ç›¸å…³æ ‡ç­¾å®šä¹‰åˆ—è¡¨
        """
        # 1. åµŒå…¥æŸ¥è¯¢
        query_embedding = await self.embedding_model.aembed(query)

        # 2. å‘é‡æ£€ç´¢
        results = self.vector_store.similarity_search_by_vector(
            vector=query_embedding,
            k=top_k
        )

        # 3. è§£æç»“æœ
        tags = []
        for doc in results:
            tags.append(TagDefinition(
                name=doc.metadata["tag"],
                definition=doc.metadata["definition"],
                similarity=doc.metadata.get("similarity", 0.0)
            ))

        return tags
```

#### 3. Judgeï¼ˆåˆ¤æ–­å™¨ï¼‰

```python
# rag/judge.py
class LLMJudge:
    """LLM åˆ¤æ–­å™¨"""

    def __init__(self, llm: GLM4):
        self.llm = llm
        self.prompt_template = self._load_prompt_template()

    async def judge(
        self,
        conversation_text: str,
        ai_tag: str,
        relevant_tags: List[TagDefinition]
    ) -> LLMJudgment:
        """
        ä½¿ç”¨ LLM åˆ¤æ–­æ ‡ç­¾æ˜¯å¦æ­£ç¡®

        Args:
            conversation_text: å¯¹è¯æ–‡æœ¬
            ai_tag: AI æ ‡ç­¾
            relevant_tags: ç›¸å…³æ ‡ç­¾å®šä¹‰

        Returns:
            LLM åˆ¤æ–­ç»“æœ
        """
        # 1. æ„å»º Prompt
        prompt = self.prompt_template.format(
            conversation=conversation_text,
            ai_tag=ai_tag,
            tag_definitions=self._format_definitions(relevant_tags)
        )

        # 2. è°ƒç”¨ LLM
        response = await self.llm.aapply(
            [prompt],
            temperature=0.1  # ä½æ¸©åº¦ï¼Œä¿è¯ç¨³å®šæ€§
        )

        # 3. è§£æå“åº”
        result = self._parse_response(response.generations[0][0].text)

        return LLMJudgment(
            is_correct=result["is_correct"],
            confidence=result["confidence"],
            recommendations=result["recommendations"],
            reasoning=result["reasoning"]
        )
```

---

## ğŸŒ API è®¾è®¡

### RESTful API è§„èŒƒ

#### åŸºç¡€ä¿¡æ¯

- **Base URL**: `http://localhost:8000/api/v1`
- **è®¤è¯**: Bearer Tokenï¼ˆå¯é€‰ï¼Œæœ¬åœ°å¼€å‘å¯ä¸å¯ç”¨ï¼‰
- **å“åº”æ ¼å¼**: JSON
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€é”™è¯¯ç 

#### API ç«¯ç‚¹åˆ—è¡¨

| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| GET | `/conversations` | è·å–å¯¹è¯åˆ—è¡¨ | âŒ |
| GET | `/conversations/:id` | è·å–å•æ¡å¯¹è¯ | âŒ |
| POST | `/conversations` | å¯¼å…¥å¯¹è¯æ•°æ® | âŒ |
| PUT | `/conversations/:id` | æ›´æ–°å¯¹è¯æ ‡ç­¾ | âŒ |
| POST | `/rag/check` | RAG æ ‡ç­¾æ£€æŸ¥ | âŒ |
| GET | `/tags` | è·å–æ‰€æœ‰æ ‡ç­¾ | âŒ |
| GET | `/tags/:id` | è·å–æ ‡ç­¾å®šä¹‰ | âŒ |
| GET | `/stats` | è·å–ç»Ÿè®¡ä¿¡æ¯ | âŒ |

### API è¯¦ç»†è®¾è®¡

#### 1. è·å–å¯¹è¯åˆ—è¡¨

```
GET /api/v1/conversations
```

**Query å‚æ•°**ï¼š
- `page`: é¡µç ï¼ˆé»˜è®¤ 1ï¼‰
- `limit`: æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤ 20ï¼‰
- `status`: çŠ¶æ€è¿‡æ»¤ï¼ˆpending/approved/skippedï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "total": 3500,
    "page": 1,
    "limit": 20,
    "items": [
      {
        "id": 1,
        "raw_text": "å¸æœºï¼šå–‚ã€‚$_$è´§ä¸»ï¼šå¸ˆå‚…ï¼Œä½ è½¦æœ‰å°¾æ¿å•Šï¼Ÿ$_$...",
        "driver_tag": ["å°¾æ¿è½¦"],
        "manual_tag": null,
        "status": "pending",
        "field_length": 65,
        "created_at": "2025-01-13T10:30:00Z"
      }
    ]
  }
}
```

#### 2. æ›´æ–°å¯¹è¯æ ‡ç­¾

```
PUT /api/v1/conversations/:id
```

**è¯·æ±‚ä½“**ï¼š
```json
{
  "manual_tag": ["å°¾æ¿è½¦", "è£…å¸è´¹"],
  "status": "approved",
  "auditor": "user123"
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "id": 1,
    "manual_tag": ["å°¾æ¿è½¦", "è£…å¸è´¹"],
    "status": "approved",
    "updated_at": "2025-01-13T10:35:00Z"
  }
}
```

#### 3. RAG æ ‡ç­¾æ£€æŸ¥

```
POST /api/v1/rag/check
```

**è¯·æ±‚ä½“**ï¼š
```json
{
  "conversation_id": 1,
  "conversation_text": "å¸æœºï¼šå–‚ã€‚$_$è´§ä¸»ï¼šå¸ˆå‚…ï¼Œä½ è½¦æœ‰å°¾æ¿å•Šï¼Ÿ$_$å¸æœºï¼šæœ‰å•Šã€‚",
  "ai_tag": "å°¾æ¿è½¦"
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "conversation_id": 1,
    "is_correct": true,
    "confidence": 0.92,
    "recommendations": [
      {
        "tag": "å°¾æ¿è½¦",
        "score": 0.92,
        "reason": "å¯¹è¯ä¸­è´§ä¸»è¯¢é—®'ä½ è½¦æœ‰å°¾æ¿å•Šï¼Ÿ'ï¼Œå¸æœºå›ç­”'æœ‰å•Š'ï¼Œæ˜ç¡®è¡¨ç¤ºæœ‰å°¾æ¿ã€‚"
      },
      {
        "tag": "æ— å°¾æ¿",
        "score": 0.05,
        "reason": "ä¸å¯¹è¯å†…å®¹ç›¸å"
      }
    ],
    "reasoning": "æ ¹æ®å¯¹è¯å†…å®¹ï¼Œå¸æœºæ˜ç¡®è¡¨ç¤ºè½¦è¾†æœ‰å°¾æ¿ï¼Œå› æ­¤'å°¾æ¿è½¦'æ ‡ç­¾æ­£ç¡®ã€‚"
  }
}
```

#### 4. è·å–æ‰€æœ‰æ ‡ç­¾

```
GET /api/v1/tags
```

**Query å‚æ•°**ï¼š
- `category`: åˆ†ç±»è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "å°¾æ¿è½¦",
      "category": "è½¦å‹ç±»",
      "definition": null,
      "created_at": "2025-01-13T10:00:00Z"
    },
    {
      "id": 2,
      "name": "è£…å¸è´¹",
      "category": "è´¹ç”¨ç±»",
      "definition": "éœ€è¦å¸æœºè£…å¸ï¼Œä¸”å¸æœºè¡¨ç¤ºéœ€è¦è£…å¸è´¹ç”¨ã€‚",
      "created_at": "2025-01-13T10:00:00Z"
    }
  ]
}
```

#### 5. è·å–ç»Ÿè®¡ä¿¡æ¯

```
GET /api/v1/stats
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "data": {
    "total_conversations": 3500,
    "audited_count": 1200,
    "pending_count": 2300,
    "accuracy_rate": 0.95,
    "average_time_per_item": 28.5,
    "rag_accuracy": 0.89
  }
}
```

---

## ğŸ”’ å®‰å…¨æ€§è®¾è®¡

### æ•°æ®å®‰å…¨

1. **æœ¬åœ°ä¼˜å…ˆ**
   - æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨æœ¬åœ° SQLite
   - ä¸éœ€è¦è”ç½‘å³å¯ä½¿ç”¨ï¼ˆRAG åŠŸèƒ½é™¤å¤–ï¼‰

2. **API Key ç®¡ç†**
   - ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯
   - `.env` æ–‡ä»¶ä¸æäº¤åˆ° Git
   - docker-compose secret ç®¡ç†

3. **è¾“å…¥éªŒè¯**
   - æ‰€æœ‰ API è¾“å…¥ä½¿ç”¨ Pydantic éªŒè¯
   - é˜²æ­¢ SQL æ³¨å…¥ï¼ˆä½¿ç”¨ ORMï¼‰
   - é˜²æ­¢ XSSï¼ˆå‰ç«¯è½¬ä¹‰ï¼‰

### æ€§èƒ½ä¼˜åŒ–

1. **ç¼“å­˜ç­–ç•¥**
   ```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Redis ç¼“å­˜åˆ†å±‚                               â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ L1: å¯¹è¯åµŒå…¥ç»“æœ (TTL: 24h)                  â”‚
   â”‚ L2: RAG æ¨èç»“æœ (TTL: 1h)                   â”‚
   â”‚ L3: æ ‡ç­¾å®šä¹‰æŸ¥è¯¢ (TTL: 12h)                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

2. **æ‰¹é‡å¤„ç†**
   - å‘é‡åµŒå…¥ï¼šæ‰¹é‡ 100 æ¡
   - æ•°æ®åº“æ“ä½œï¼šä½¿ç”¨äº‹åŠ¡æ‰¹é‡æäº¤

3. **é¢„åŠ è½½**
   - å‰ç«¯é¢„åŠ è½½ä¸‹ä¸€æ¡å¯¹è¯
   - åç«¯é¢„è®¡ç®— RAG æ¨è

---

**æœ€åæ›´æ–°**: 2025-01-13
**ç»´æŠ¤è€…**: Smart Labeling Workbench Team
